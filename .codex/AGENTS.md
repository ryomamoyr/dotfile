# 個人共通ルール（全プロジェクト適用）

## 目的
作業開始前にこの指示を必ず読み、以降の提案・実装・出力に反映すること。

---

## 作業合意（共通）
- ユーザーの要件・制約を最優先し、勝手な前提追加をしない
- 実装前に「何をするか」を短く箇条書きで示す（過剰な前置きは不要）
- 不明点があっても進められる場合は進める。進められない場合のみ最小限を確認する
- 出力はユーザーがそのまま実行・貼り付けできる形に整える
- 不要な依存追加はしない（追加が必要なら理由を添えて提案する）
- 既存コードの改変は最小差分を優先する

---

## 安全・慎重運用
- 削除・上書き・権限変更などの破壊的操作はデフォルトで行わない
- 履歴改変（rebase / reset --hard / force push）はデフォルトで行わない
- 外部通信や機密に関わる操作を提案する場合は、影響範囲と代替案を短く示す

---

## 実行環境（uv固定）
- プロジェクトのPython実行環境は **uvが管理する仮想環境**を使用する（デフォルトは `.venv/`）
- 依存管理は `pyproject.toml` と `uv.lock` を正とし、最新に保つ
- 環境作成・同期は `uv sync` を基本とする（必要なら `uv venv` でもよい）
- 依存の追加：`uv add <package>`、削除：`uv remove <package>`
- 依存解決・ロック生成/更新：`uv lock`（必要に応じて）
- 実行：`uv run <script>.py`
- `requirements.txt` を正として運用しない（外部互換など必要時のみ例外）
- 手動 `python -m venv` を正として運用しない

### uv トラブルシュート
- 依存が変なのに見える／解決が崩れた：`uv sync` →（必要なら）`uv lock` → `uv sync`
- `.venv` を作り直したい：`.venv` を削除 → `uv sync`
- キャッシュが原因っぽい：`uv cache dir` で場所確認 → `uv cache clean`


---

## Pythonコーディング規約（必ず遵守）
- リーダブルなコードを心がける
- 回答時は必ず完全なコードを提示する（省略や一部抜粋は禁止）
- 不要な中間生成物を極力作らない（メモリ効率優先）
- 型アノテーションは標準の型表記（dict, list, tuple など）のみ使用（typing由来は禁止）
- コメントは設計の要点のみを日本語で簡潔に（冗長コメント禁止）
- 不要な try-except による例外補足は行わない
- 不要な if 条件分岐で複雑化しない（必要性がある場合のみ）
- 関数名は動詞始まり。一関数＝一目的。ETL・集計・可視化を明確に分離する

### 定数化（マジックナンバーの扱い）
- 「意味を持つ閾値・条件値・仕様値」は定数として明示する
  - 例：フィルタ閾値、許容誤差、ビン数、期間（日数）、上限/下限、採用基準など
- 「一度しか使わない表示上の微調整」まで機械的に定数化しない
  - 例：図タイトルのフォントサイズ、余白、線幅などの単発調整は行内で数値直書きでよい
- ただし、同種の値を複数箇所で使う／比較のため固定する場合は定数化する

---

## データ処理（Polars固定）
- 分析・ETLは Polars を使用する（Pandasは禁止）
- 可能な限り LazyFrame を活用し、不要な collect() を増やさない
- チェーンの可読性を優先し、with_columns / select は改行して整理する
- to_pandas() は禁止

---

## 可視化（Seaborn）
- 可視化は Seaborn を使用する（Matplotlibは補助用途のみ）
- fig, ax 形式で描画コードを記述する
- Seabornのテーマ・スタイルを独自に変更しない（デフォルト）
- sns.histplot / sns.boxplot / sns.barplot は ax= を明示する
- 軸ラベル・タイトルは日本語で明示する
- 比較可能性のため、色・凡例・軸範囲は必要に応じて固定する（要求がある場合は最優先）

### 色（指定がない場合のデフォルト）
- ユーザーから色指定がない場合は以下のパレットを使用する

```python
PALETTE = sns.color_palette(
    [
        "#0031D8",  # positive_bar
        "#FA0000",  # negative_bar
        "#C5D7FB",  # positive_data_bar
        "#FFBBBB",  # negative_data_bar
        "#1A1A1A",  # body
        "#626264",  # description
    ]
)
```

---

## Notebook出力（分析タスク）

* 分析はJupyter想定でセル単位に分けて提示する
* 各セルの先頭に、セルの役割が分かる短い見出しコメントを置く（番号は付けない）

  * 例：`# 読み込み`, `# 前処理`, `# 結合`, `# 集計`, `# 可視化`
* セル間の切り替わりは空行で明確化する
* 表・集計は再現可能なコードで生成する（手計算の貼り付けはしない）

---

## Git運用ルール

* 既にブランチが切られている前提で、可能な範囲で変更を反映し、pushまで行う
* ただし履歴改変（rebase / reset --hard / force push）はデフォルトで行わない

### 手順（原則）

* 状態確認：`git status` / `git diff`
* ステージ：原則 `git add -p`（分ける価値がない場合は `git add <paths>`）
* コミット：日本語で簡潔に1行（必要なら2行目以降に補足）
* push：`git push -u origin HEAD`（初回のみ upstream 設定）

### コミットメッセージ（日本語）

* 例：

  * `可視化の軸ラベルを日本語に統一`
  * `uv sync 手順を追記`
  * `Polars集計の型不整合を修正`
* 雑多な変更を1コミットに詰めない。意味のある単位で分ける

---

## 指示が矛盾した場合

* より下の階層（現在ディレクトリに近い）にある AGENTS / AGENTS.override の指示を優先する
* 矛盾がある場合は、優先した内容と差分・リスクを短く明示する
